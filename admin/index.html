<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ | ã¶ã¡ç™’ã—ãƒ•ã‚§ã‚¹ã‚¿æ±äº¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }

        .card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .input-field {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 50;
        }
    </style>
</head>

<body class="p-4 max-w-5xl mx-auto">

    <div id="loading" class="loading-overlay hidden">
        <div class="text-xl">å‡¦ç†ä¸­...</div>
    </div>

    <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">ğŸ›  è¨­å®šç®¡ç†ç”»é¢</h1>
        <div class="flex gap-2">
            <button onclick="fetchConfig()" class="btn bg-gray-500 text-white hover:bg-gray-600">å†èª­ã¿è¾¼ã¿</button>
            <button onclick="saveConfig()" class="btn btn-primary">ä¿å­˜ã™ã‚‹</button>
        </div>
    </header>

    <div id="authSection" class="card">
        <h2 class="text-lg font-bold mb-4">èªè¨¼</h2>
        <div class="input-group">
            <label class="input-label">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
            <input type="password" id="passcode" class="input-field" placeholder="ç°¡æ˜“èªè¨¼ã‚³ãƒ¼ãƒ‰">
        </div>
        <button onclick="checkAuth()" class="btn btn-primary w-full">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="mainContent" class="hidden">

        <!-- åŸºæœ¬è¨­å®š -->
        <section class="card">
            <h2 class="text-lg font-bold mb-4 text-blue-600 border-b pb-2">åŸºæœ¬è¨­å®š</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label class="input-label">æ—©å‰²æœŸé™ (YYYY-MM-DD HH:mm:ss)</label>
                    <input type="text" id="earlyBirdDeadline" class="input-field">
                </div>
                <div class="input-group">
                    <label class="input-label">ä¼šå“¡å‰²å¼•é¡ (å††)</label>
                    <input type="number" id="memberDiscount" class="input-field">
                </div>
                <div class="input-group">
                    <label class="input-label">LIFF ID</label>
                    <input type="text" id="liffId" class="input-field" placeholder="1657xxxxx-xxxxxx">
                </div>
            </div>
        </section>

        <!-- å˜ä¾¡è¨­å®š -->
        <section class="card">
            <h2 class="text-lg font-bold mb-4 text-green-600 border-b pb-2">ã‚ªãƒ—ã‚·ãƒ§ãƒ³å˜ä¾¡è¨­å®š</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="input-group"><label class="input-label">è¿½åŠ æ¤…å­</label><input type="number" id="price_chair"
                        class="input-field"></div>
                <div class="input-group"><label class="input-label">é›»æºä½¿ç”¨</label><input type="number" id="price_power"
                        class="input-field"></div>
                <div class="input-group"><label class="input-label">è¿½åŠ ã‚¹ã‚¿ãƒƒãƒ•</label><input type="number" id="price_staff"
                        class="input-field"></div>
                <div class="input-group"><label class="input-label">æ‡‡è¦ªä¼š</label><input type="number" id="price_party"
                        class="input-field"></div>
                <div class="input-group"><label class="input-label">äºŒæ¬¡ä¼š</label><input type="number"
                        id="price_secondaryParty" class="input-field"></div>
            </div>
        </section>

        <!-- ãƒ–ãƒ¼ã‚¹è¨­å®š -->
        <section class="card">
            <h2 class="text-lg font-bold mb-4 text-orange-600 border-b pb-2">ãƒ–ãƒ¼ã‚¹è¨­å®š (æº€æ åˆ‡ã‚Šæ›¿ãˆ)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 border-b">
                            <th class="p-2">ID</th>
                            <th class="p-2">ãƒ–ãƒ¼ã‚¹å</th>
                            <th class="p-2">é€šå¸¸ä¾¡æ ¼</th>
                            <th class="p-2">æ—©å‰²ä¾¡æ ¼</th>
                            <th class="p-2 text-center">æº€æ  (Sold Out)</th>
                        </tr>
                    </thead>
                    <tbody id="boothTableBody">
                        <!-- JSã§ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <script src="../apply/config.js"></script>
    <script>
        // ç°¡æ˜“èªè¨¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã—ã¦ã¯å¼±ã„ãŒè¦ä»¶ã«åˆã‚ã›ã¦å®Ÿè£…ï¼‰
        const CORRECT_PASS = "admin1234"; // ä»®ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰
        let currentConfig = {};

        function checkAuth() {
            const input = document.getElementById('passcode').value;
            if (input === CORRECT_PASS) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                fetchConfig();
            } else {
                alert('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
            }
        }

        async function fetchConfig() {
            showLoading(true);
            try {
                // Configãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’ä½¿ç”¨
                const url = CONFIG.workerUrl;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getConfig' })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                currentConfig = data;
                renderUI(data);

            } catch (error) {
                console.error('Fetch error:', error);
                alert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function renderUI(config) {
            // åŸºæœ¬è¨­å®š
            document.getElementById('earlyBirdDeadline').value = config.earlyBirdDeadline || '';
            document.getElementById('memberDiscount').value = config.memberDiscount || 0;
            document.getElementById('liffId').value = config.liffId || '';

            // å˜ä¾¡
            if (config.unitPrices) {
                document.getElementById('price_chair').value = config.unitPrices.chair || 0;
                document.getElementById('price_power').value = config.unitPrices.power || 0;
                document.getElementById('price_staff').value = config.unitPrices.staff || 0;
                document.getElementById('price_party').value = config.unitPrices.party || 0;
                document.getElementById('price_secondaryParty').value = config.unitPrices.secondaryParty || 0;
            }

            // ãƒ–ãƒ¼ã‚¹è¨­å®š
            const tbody = document.getElementById('boothTableBody');
            tbody.innerHTML = '';

            // Configã«ãƒ–ãƒ¼ã‚¹ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®šç¾©ã‚’ä½¿ç”¨ï¼ˆåˆå›ï¼‰
            const booths = config.booths && config.booths.length > 0 ? config.booths : CONFIG.booths;

            booths.forEach((booth, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="p-2 text-sm text-gray-500">${booth.id}</td>
                    <td class="p-2 font-bold">${booth.name}</td>
                    <td class="p-2"><input type="number" class="input-field w-24" value="${booth.prices.regular}" onchange="updateBoothPrice(${index}, 'regular', this.value)"></td>
                    <td class="p-2"><input type="number" class="input-field w-24" value="${booth.prices.earlyBird}" onchange="updateBoothPrice(${index}, 'earlyBird', this.value)"></td>
                    <td class="p-2 text-center">
                        <input type="checkbox" class="w-6 h-6 text-red-600" ${booth.soldOut ? 'checked' : ''} onchange="updateBoothSoldOut(${index}, this.checked)">
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // é…åˆ—ã‚’åŒæœŸï¼ˆåˆå›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨æ™‚ãªã©ã®ãŸã‚ï¼‰
            currentConfig.booths = JSON.parse(JSON.stringify(booths));
        }

        function updateBoothPrice(index, type, value) {
            currentConfig.booths[index].prices[type] = Number(value);
        }

        function updateBoothSoldOut(index, isChecked) {
            currentConfig.booths[index].soldOut = isChecked;
        }

        async function saveConfig() {
            if (!confirm('è¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;

            // å€¤ã®åé›†
            currentConfig.earlyBirdDeadline = document.getElementById('earlyBirdDeadline').value;
            currentConfig.memberDiscount = Number(document.getElementById('memberDiscount').value);
            currentConfig.liffId = document.getElementById('liffId').value;

            currentConfig.unitPrices = {
                chair: Number(document.getElementById('price_chair').value),
                power: Number(document.getElementById('price_power').value),
                staff: Number(document.getElementById('price_staff').value),
                party: Number(document.getElementById('price_party').value),
                secondaryParty: Number(document.getElementById('price_secondaryParty').value)
            };

            showLoading(true);
            try {
                const url = CONFIG.workerUrl;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'saveConfig',
                        payload: currentConfig
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
                } else {
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }
    </script>
</body>

</html>